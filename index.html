<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>地図切出 (Exif対応版)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #controls {
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid #ccc;
            flex-wrap: wrap;
        }
        #map { flex-grow: 1; width: 100%; }
        
        button {
            padding: 8px 16px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
        }
        button:hover { background-color: #0056b3; }

        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 2000;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: red;
            box-shadow: 0 0 2px white;
        }
        .crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        .crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
    </style>
</head>
<body>

<div id="controls">
    <select id="prefSelect" onchange="changePref()">
        <option value="43.064,141.347">北海道</option>
        <option value="40.824,140.740">青森県</option>
        <option value="39.703,141.152">岩手県</option>
        <option value="38.268,140.871">宮城県</option>
        <option value="39.718,140.102">秋田県</option>
        <option value="38.255,140.339">山形県</option>
        <option value="37.750,140.467">福島県</option>
        <option value="36.341,140.446">茨城県</option>
        <option value="36.565,139.883">栃木県</option>
        <option value="36.391,139.060">群馬県</option>
        <option value="35.857,139.648">埼玉県</option>
        <option value="35.605,140.123">千葉県</option>
        <option value="35.689,139.691">東京都</option>
        <option value="35.447,139.642">神奈川県</option>
        <option value="37.902,139.023">新潟県</option>
        <option value="36.695,137.211">富山県</option>
        <option value="36.594,136.625">石川県</option>
        <option value="36.065,136.221" selected>福井県</option> 
        <option value="35.663,138.568">山梨県</option>
        <option value="36.651,138.181">長野県</option>
        <option value="35.391,136.722">岐阜県</option>
        <option value="34.976,138.383">静岡県</option>
        <option value="35.180,136.906">愛知県</option>
        <option value="34.730,136.508">三重県</option>
        <option value="35.021,135.755">滋賀県</option>
        <option value="35.011,135.768">京都府</option>
        <option value="34.686,135.520">大阪府</option>
        <option value="34.691,135.183">兵庫県</option>
        <option value="34.685,135.832">奈良県</option>
        <option value="34.226,135.167">和歌山県</option>
        <option value="35.503,134.238">鳥取県</option>
        <option value="35.472,133.050">島根県</option>
        <option value="34.661,133.935">岡山県</option>
        <option value="34.396,132.459">広島県</option>
        <option value="34.186,131.470">山口県</option>
        <option value="34.065,134.559">徳島県</option>
        <option value="34.340,134.043">香川県</option>
        <option value="33.841,132.766">愛媛県</option>
        <option value="33.559,133.531">高知県</option>
        <option value="33.606,130.418">福岡県</option>
        <option value="33.249,130.298">佐賀県</option>
        <option value="32.744,129.873">長崎県</option>
        <option value="32.789,130.741">熊本県</option>
        <option value="33.238,131.612">大分県</option>
        <option value="31.911,131.423">宮崎県</option>
        <option value="31.560,130.558">鹿児島県</option>
        <option value="26.212,127.681">沖縄県</option>
    </select>
    
    <button onclick="downloadMapImageWithExif()">現在表示中の地図を保存(Exif付)</button>
</div>

<div class="crosshair"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
<script src="https://unpkg.com/piexifjs@1.0.6/piexif.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const latParam = urlParams.get('lat');
    const lonParam = urlParams.get('lon');

    let startLat = 36.065;
    let startLon = 136.221;
    let startZoom = 15;
    let isJumped = false; 

    if (latParam && lonParam && !isNaN(latParam) && !isNaN(lonParam)) {
        startLat = parseFloat(latParam);
        startLon = parseFloat(lonParam);
        startZoom = 16; 
        isJumped = true; 
    }

    const map = L.map('map', {
        preferCanvas: true
    }).setView([startLat, startLon], startZoom);

    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    });

    if (isJumped) {
        L.marker([startLat, startLon]).addTo(map).bindPopup('<b>指定された位置</b>').openPopup();
        document.querySelector('.crosshair').style.display = 'none';
    }


    const opt = { attribution: '地理院タイル', crossOrigin: "anonymous", maxZoom: 18 };
    const optEsri = { attribution: 'Esri World Imagery', crossOrigin: "anonymous", maxZoom: 18 };

    const photo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', opt);
    const photoOld = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/gazo1/{z}/{x}/{y}.jpg', opt);
    const std = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', opt);
    const pale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', opt);
    const slope = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/slopemap/{z}/{x}/{y}.png', { ...opt, opacity: 0.7 });
    const relief = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', { ...opt, opacity: 0.6 });
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', optEsri);
    const rinpan = L.tileLayer('https://rinya-tiles.geospatial.jp/fr_layer_webp_2025/{z}/{x}/{y}.webp', {
        attribution: '林野庁 森林計画対象森林レイヤ',
        crossOrigin: "anonymous", 
        maxZoom: 16
    });

    photo.addTo(map);

    const baseMaps = {
        "最新空中写真（地理院）": photo,
        "過去空中写真(1974-78)": photoOld,
        "衛星画像（Esri）": esri,
        "標準地図": std,
        "淡色地図": pale,
        "傾斜量図（地形把握）": slope,
        "色別標高図": relief,
        "全国林班図（民有：薄緑、国有：濃緑）": rinpan
    };

    L.control.layers(baseMaps, null, { collapsed: false }).addTo(map);

    function changePref() {
        const select = document.getElementById("prefSelect");
        const val = select.value.split(","); 
        const lat = parseFloat(val[0]);
        const lon = parseFloat(val[1]);
        map.setView([lat, lon], 10);
    }

    const snapshotOptions = {
        hideElementsWithSelectors: [
            ".leaflet-control-container",
            ".leaflet-dont-include-pane",
            "#controls",
            ".crosshair"
        ],
        mimeType: "image/jpeg"
    };
    const screenshoter = L.simpleMapScreenshoter(snapshotOptions).addTo(map);

    // ★大改造★ Exifを書き込んで保存する関数
    function downloadMapImageWithExif() {
        const bounds = map.getBounds();
        const south = bounds.getSouth().toFixed(6);
        const west = bounds.getWest().toFixed(6);
        const north = bounds.getNorth().toFixed(6);
        const east = bounds.getEast().toFixed(6);
        
        let activeLayerName = "map";
        map.eachLayer(function(layer){
            if(layer === photo) activeLayerName = "photo";
            else if(layer === photoOld) activeLayerName = "old74";
            else if(layer === slope) activeLayerName = "slope";
            else if(layer === std) activeLayerName = "std";
            else if(layer === esri) activeLayerName = "satellite";
            else if(layer === pale) activeLayerName = "pale";
            else if(layer === relief) activeLayerName = "relief";
            else if(layer === rinpan) activeLayerName = "rinpan";
        });

        // 依然としてファイル名にも座標を入れておきます（人間が見て分かるように）
        const filename = `${activeLayerName}_${south}_${west}_${north}_${east}.jpg`;

        screenshoter.takeScreen('image')
            .then(jpegDataUrl => {
                
                // --- ここからが Exif 埋め込みの魔法 ---
                // 保存する座標をカンマ区切りの文字列にします
                const coordsString = `${south},${west},${north},${east}`;
                
                // 空のExifデータ（キャンバス）を作成
                const zeroth = {};
                const exif = {};
                const gps = {};
                
                // Exifの「ImageDescription（画像の説明）」という項目に、座標文字列を隠して書き込む
                zeroth[piexif.ImageIFD.ImageDescription] = coordsString;
                
                const exifObj = {"0th": zeroth, "Exif": exif, "GPS": gps};
                // Exifデータをバイナリに変換
                const exifBytes = piexif.dump(exifObj);
                
                // 生成された地図画像(jpegDataUrl)に、Exifバイナリを合体させる！
                const newDataUrl = piexif.insert(exifBytes, jpegDataUrl);
                // --- 魔法ここまで ---

                // 合体済みの新しい画像をダウンロードさせる
                const link = document.createElement('a');
                link.download = filename;
                link.href = newDataUrl;
                link.click();
            })
            .catch(e => {
                alert("画像の保存に失敗しました。\n" + e.toString());
            });
    }
</script>

</body>
</html>
