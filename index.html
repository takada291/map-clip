<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>林小班図アプリ用 地図切り出しツール</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #controls {
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
        }
        #map { flex-grow: 1; width: 100%; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background-color: #0056b3; }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 9999; /* 地図より手前に */
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: red;
        }
        .crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        .crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
    </style>
</head>
<body>

<div id="controls">
    <button onclick="downloadMapImage()">この範囲を保存 (A4/5000想定)</button>
    <span style="font-size:12px;">※保存時にファイル名が自動で座標になります</span>
</div>

<div class="crosshair"></div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

<script>
    // 1. 地図の初期化（福井県付近）
    const map = L.map('map', {
        preferCanvas: true // 画像化のためにCanvasモードを優先
    }).setView([36.062, 136.223], 15);

    // 2. 地理院地図（空中写真）レイヤー設定
    // crossOrigin: "anonymous" が重要（これがないと画像保存時にセキュリティエラーになる）
    const photoLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
        attribution: '地理院タイル',
        crossOrigin: "anonymous", 
        maxZoom: 18
    }).addTo(map);

    // 標準地図への切り替え用
    const stdLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: '地理院タイル',
        crossOrigin: "anonymous",
        maxZoom: 18
    });

    L.control.layers({
        "空中写真": photoLayer,
        "標準地図": stdLayer
    }).addTo(map);

    // 3. スクリーンショット機能の初期化
    const snapshotOptions = {
        hideElementsWithSelectors: [
            ".leaflet-control-container",
            ".leaflet-dont-include-pane",
            "#controls"
        ],
        mimeType: "image/jpeg"
    };
    const screenshoter = L.simpleMapScreenshoter(snapshotOptions).addTo(map);

    // 4. 保存ボタンの処理
    async function downloadMapImage() {
        // 現在の表示範囲（緯度経度）を取得
        const bounds = map.getBounds();
        const south = bounds.getSouth().toFixed(6);
        const west = bounds.getWest().toFixed(6);
        const north = bounds.getNorth().toFixed(6);
        const east = bounds.getEast().toFixed(6);

        // ファイル名を生成 (例: map_36.060717_136.279386_36.066139_136.288754.jpg)
        // タイトル部分は任意に変更可能です
        const filename = `map_${south}_${west}_${north}_${east}`;

        try {
            // 画像を生成してダウンロード
            await screenshoter.takeScreen("image", {
                caption: null
            }).then(blob => {
                const link = document.createElement('a');
                link.download = filename + ".jpg";
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
            });
        } catch (e) {
            alert("画像の保存に失敗しました。\n" + e);
        }
    }

    // A4 1:5000 の目安スケール（簡易実装）
    // PC画面の解像度によりますが、大まかに「幅1.5km程度」を表示するようにズーム調整
    // 完全に固定するにはウィンドウサイズ制御が必要ですが、今回は「見たまま保存」を優先
</script>

</body>
</html>