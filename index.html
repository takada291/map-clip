<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>地図切出</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #controls {
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid #ccc;
            flex-wrap: wrap; /* スマホでボタンが溢れないように */
        }
        #map { flex-grow: 1; width: 100%; }
        
        /* ボタンのデザイン */
        button {
            padding: 8px 16px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
        }
        button:hover { background-color: #0056b3; }

        /* 都道府県セレクトボックスのデザイン */
        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        /* 画面中央の十字キー */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 2000;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: red;
            box-shadow: 0 0 2px white;
        }
        .crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        .crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
    </style>
</head>
<body>

<div id="controls">
    <select id="prefSelect" onchange="changePref()">
        <option value="43.064,141.347">北海道</option>
        <option value="40.824,140.740">青森県</option>
        <option value="39.703,141.152">岩手県</option>
        <option value="38.268,140.871">宮城県</option>
        <option value="39.718,140.102">秋田県</option>
        <option value="38.255,140.339">山形県</option>
        <option value="37.750,140.467">福島県</option>
        <option value="36.341,140.446">茨城県</option>
        <option value="36.565,139.883">栃木県</option>
        <option value="36.391,139.060">群馬県</option>
        <option value="35.857,139.648">埼玉県</option>
        <option value="35.605,140.123">千葉県</option>
        <option value="35.689,139.691">東京都</option>
        <option value="35.447,139.642">神奈川県</option>
        <option value="37.902,139.023">新潟県</option>
        <option value="36.695,137.211">富山県</option>
        <option value="36.594,136.625">石川県</option>
        <option value="36.065,136.221" selected>福井県</option> 
        <option value="35.663,138.568">山梨県</option>
        <option value="36.651,138.181">長野県</option>
        <option value="35.391,136.722">岐阜県</option>
        <option value="34.976,138.383">静岡県</option>
        <option value="35.180,136.906">愛知県</option>
        <option value="34.730,136.508">三重県</option>
        <option value="35.021,135.755">滋賀県</option>
        <option value="35.011,135.768">京都府</option>
        <option value="34.686,135.520">大阪府</option>
        <option value="34.691,135.183">兵庫県</option>
        <option value="34.685,135.832">奈良県</option>
        <option value="34.226,135.167">和歌山県</option>
        <option value="35.503,134.238">鳥取県</option>
        <option value="35.472,133.050">島根県</option>
        <option value="34.661,133.935">岡山県</option>
        <option value="34.396,132.459">広島県</option>
        <option value="34.186,131.470">山口県</option>
        <option value="34.065,134.559">徳島県</option>
        <option value="34.340,134.043">香川県</option>
        <option value="33.841,132.766">愛媛県</option>
        <option value="33.559,133.531">高知県</option>
        <option value="33.606,130.418">福岡県</option>
        <option value="33.249,130.298">佐賀県</option>
        <option value="32.744,129.873">長崎県</option>
        <option value="32.789,130.741">熊本県</option>
        <option value="33.238,131.612">大分県</option>
        <option value="31.911,131.423">宮崎県</option>
        <option value="31.560,130.558">鹿児島県</option>
        <option value="26.212,127.681">沖縄県</option>
    </select>
    
    <button onclick="downloadMapImage()">現在表示中の地図を保存</button>
</div>

<div class="crosshair"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

<script>
    // 1. 地図の初期化（初期位置：福井県庁付近）
    const map = L.map('map', {
        preferCanvas: true
    }).setView([36.065, 136.221], 15);

    // ==================================================
    // 2. 地図データの定義
    // ==================================================
    
    const opt = { attribution: '地理院タイル', crossOrigin: "anonymous", maxZoom: 18 };
    const optEsri = { attribution: 'Esri World Imagery', crossOrigin: "anonymous", maxZoom: 18 };

    // A. 地理院地図：最新空中写真
    const photo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', opt);

    // A2. 地理院地図：空中写真（1974-1978年頃）
    const photoOld = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/gazo1/{z}/{x}/{y}.jpg', opt);

    // B. 地理院地図：標準地図
    const std = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', opt);

    // C. 地理院地図：淡色地図
    const pale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', opt);

    // D. 地理院地図：傾斜量図
    const slope = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/slopemap/{z}/{x}/{y}.png', {
        ...opt, opacity: 0.7 
    });

    // E. 地理院地図：色別標高図
    const relief = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', {
        ...opt, opacity: 0.6
    });

    // F. Esri World Imagery
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', optEsri);

    // ★追加★ G. 林野庁：森林計画対象森林レイヤ（全国林班・小班）
    const rinpan = L.tileLayer('https://rinya-tiles.geospatial.jp/fr_layer_webp_2025/{z}/{x}/{y}.webp', {
        attribution: '林野庁 森林計画対象森林レイヤ',
        crossOrigin: "anonymous", 
        maxZoom: 16 // APIの仕様に基づき最大16
    });

    // 初期表示
    photo.addTo(map);

    // ==================================================
    // 3. レイヤー切り替えコントロール
    // ==================================================
    const baseMaps = {
        "最新空中写真（地理院）": photo,
        "過去空中写真(1974-78)": photoOld,
        "衛星画像（Esri）": esri,
        "標準地図": std,
        "淡色地図": pale,
        "傾斜量図（地形把握）": slope,
        "色別標高図": relief,
        "全国林班・小班（林野庁）": rinpan // ★追加
    };

    L.control.layers(baseMaps, null, { collapsed: false }).addTo(map);


    // ==================================================
    // 4. 都道府県切り替え機能
    // ==================================================
    function changePref() {
        const select = document.getElementById("prefSelect");
        const val = select.value.split(","); // "lat,lon" を分割
        const lat = parseFloat(val[0]);
        const lon = parseFloat(val[1]);
        
        // 指定した座標へジャンプ（ズームレベルは少し広域の10に設定）
        map.setView([lat, lon], 10);
    }


    // ==================================================
    // 5. 画像保存機能
    // ==================================================
    const snapshotOptions = {
        hideElementsWithSelectors: [
            ".leaflet-control-container",
            ".leaflet-dont-include-pane",
            "#controls",
            ".crosshair"
        ],
        mimeType: "image/jpeg"
    };
    const screenshoter = L.simpleMapScreenshoter(snapshotOptions).addTo(map);

    function downloadMapImage() {
        const bounds = map.getBounds();
        const south = bounds.getSouth().toFixed(6);
        const west = bounds.getWest().toFixed(6);
        const north = bounds.getNorth().toFixed(6);
        const east = bounds.getEast().toFixed(6);
        
        // ファイル名のプレフィックス決定
        let activeLayerName = "map";
        map.eachLayer(function(layer){
            if(layer === photo) activeLayerName = "photo";
            else if(layer === photoOld) activeLayerName = "old74";
            else if(layer === slope) activeLayerName = "slope";
            else if(layer === std) activeLayerName = "std";
            else if(layer === esri) activeLayerName = "satellite";
            else if(layer === pale) activeLayerName = "pale";
            else if(layer === relief) activeLayerName = "relief";
            else if(layer === rinpan) activeLayerName = "rinpan"; // ★追加
        });

        const filename = `${activeLayerName}_${south}_${west}_${north}_${east}.jpg`;

        screenshoter.takeScreen('image')
            .then(image => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = image;
                link.click();
            })
            .catch(e => {
                alert("画像の保存に失敗しました。\n" + e.toString());
            });
    }
</script>

</body>
</html>
