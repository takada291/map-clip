<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>地図切出</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #controls {
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid #ccc;
        }
        #map { flex-grow: 1; width: 100%; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
        
        /* 画面中央の十字キー */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 2000;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: red;
            box-shadow: 0 0 2px white; /* 見やすくするために白枠を追加 */
        }
        .crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        .crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
    </style>
</head>
<body>

<div id="controls">
    <button onclick="downloadMapImage()">現在表示中の地図を保存</button>
</div>

<div class="crosshair"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

<script>
    // 1. 地図の初期化（初期位置：福井県）
    const map = L.map('map', {
        preferCanvas: true
    }).setView([36.062, 136.223], 15);

    // ==================================================
    // 2. 地図データの定義（すべて無料・登録不要のもの）
    // ==================================================
    
    // 共通設定：クロスオリジン（画像保存のために必須）
    const opt = { attribution: '地理院タイル', crossOrigin: "anonymous", maxZoom: 18 };
    const optEsri = { attribution: 'Esri World Imagery', crossOrigin: "anonymous", maxZoom: 18 };

    // A. 地理院地図：空中写真（オルソ画像）
    const photo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', opt);

    // B. 地理院地図：標準地図
    const std = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', opt);

    // C. 地理院地図：淡色地図（文字や線を書き込むのに便利）
    const pale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', opt);

    // D. 地理院地図：傾斜量図（★林業おすすめ！地形が影絵のように見えます）
    const slope = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/slopemap/{z}/{x}/{y}.png', {
        ...opt, opacity: 0.7 // 少し透かして表示
    });

    // E. 地理院地図：色別標高図（高さで色分け）
    const relief = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', {
        ...opt, opacity: 0.6
    });

    // F. Esri World Imagery（Sentinel等の代替：世界中の衛星写真）
    // ※地理院写真より撮影時期が新しい場合があります
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', optEsri);

    // 初期表示設定
    photo.addTo(map);


    // ==================================================
    // 3. レイヤー切り替えコントロールの追加
    // ==================================================
    const baseMaps = {
        "空中写真（地理院）": photo,
        "衛星画像（Esri）": esri,
        "標準地図": std,
        "淡色地図": pale,
        "傾斜量図（地形把握）": slope,
        "色別標高図": relief
    };

    L.control.layers(baseMaps, null, { collapsed: false }).addTo(map);
    // collapsed: false にしたので、常にリストが右上に表示されます


    // ==================================================
    // 4. 画像保存機能
    // ==================================================
    const snapshotOptions = {
        hideElementsWithSelectors: [
            ".leaflet-control-container",
            ".leaflet-dont-include-pane",
            "#controls",
            ".crosshair"
        ],
        mimeType: "image/jpeg"
    };
    const screenshoter = L.simpleMapScreenshoter(snapshotOptions).addTo(map);

    function downloadMapImage() {
        const bounds = map.getBounds();
        // 座標取得（林小班図アプリ命名規則用）
        const south = bounds.getSouth().toFixed(6);
        const west = bounds.getWest().toFixed(6);
        const north = bounds.getNorth().toFixed(6);
        const east = bounds.getEast().toFixed(6);
        
        // 選択中のレイヤー名を取得（ファイル名に付けると管理しやすい）
        let activeLayerName = "map";
        map.eachLayer(function(layer){
            // 簡易的に判定（実際には複数の場合があるが、ベースマップ名を推測）
            if(layer === photo) activeLayerName = "photo";
            else if(layer === slope) activeLayerName = "slope";
            else if(layer === std) activeLayerName = "std";
            else if(layer === esri) activeLayerName = "satellite";
        });

        const filename = `${activeLayerName}_${south}_${west}_${north}_${east}.jpg`;

        screenshoter.takeScreen('image')
            .then(image => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = image;
                link.click();
            })
            .catch(e => {
                alert("画像の保存に失敗しました。\n" + e.toString());
            });
    }
</script>

</body>
</html>
